{% extends 'custom_admin/base_admin.html' %}
{% load static %}

{% block title %}Analytics - Corrige Moi Admin{% endblock %}

{% block extra_css %}
<link type="text/css" href="{% static 'custom_admin/css/plugins/apexcharts.css' %}" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="page-title mb-4">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h2 class="fw-bold mb-2">Analytics</h2>
                        <p class="text-muted mb-0">Suivi en temps réel de la plateforme</p>
                    </div>
                    <div class="d-flex gap-2">
                        <select class="form-select" id="periodSelect" style="width: 160px;">
                            <option value="7" {% if analytics.period == 7 %}selected{% endif %}>7 jours</option>
                            <option value="30" {% if analytics.period == 30 %}selected{% endif %}>30 jours</option>
                            <option value="90" {% if analytics.period == 90 %}selected{% endif %}>90 jours</option>
                        </select>
                        <button class="btn btn-primary" onclick="refreshAnalytics()">
                            <i class="mdi mdi-refresh"></i> Actualiser
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- KPI Cards -->
    <div class="row g-3 mb-4">
        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="fw-bold text-primary">{{ analytics.user_growth.this_month }}</h4>
                            <p class="text-muted small">Nouveaux utilisateurs</p>
                            <small class="text-success">
                                <i class="mdi mdi-arrow-up"></i> +{{ analytics.user_growth.growth_rate }}%
                            </small>
                        </div>
                        <i class="mdi mdi-account-plus text-primary fs-3"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="fw-bold text-success">{{ analytics.kpi.total_revenue|floatformat:0 }} CFA</h4>
                            <p class="text-muted small">Revenus totaux</p>
                        </div>
                        <i class="mdi mdi-currency-usd text-success fs-3"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="fw-bold text-info">{{ analytics.kpi.retention_rate }}%</h4>
                            <p class="text-muted small">Rétention 30j</p>
                        </div>
                        <i class="mdi mdi-account-check text-info fs-3"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="fw-bold text-warning">{{ analytics.live.active_users }}</h4>
                            <p class="text-muted small">En ligne (5 min)</p>
                            <span class="badge bg-danger small">LIVE</span>
                        </div>
                        <i class="mdi mdi-circle text-danger fs-4 blink"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Graphiques -->
    <div class="row mb-4">
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white">
                    <h5>Activité quotidienne</h5>
                </div>
                <div class="card-body">
                    <div id="activityChart"></div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white">
                    <h5>Top Packs</h5>
                </div>
                <div class="card-body">
                    {% for pack in analytics.top_packs %}
                    <div class="d-flex justify-content-between mb-2">
                        <span class="small text-muted">{{ pack.name }}</span>
                        <strong>{{ pack.revenue|floatformat:0 }} CFA</strong>
                    </div>
                    <div class="progress mb-3" style="height: 5px;">
                        <div class="progress-bar bg-success" style="width: {% widthratio pack.revenue analytics.kpi.total_revenue 100 %}%"></div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-6">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white">
                    <h5>Utilisation par type</h5>
                </div>
                <div class="card-body">
                    <div id="usageChart"></div>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white">
                    <h5>Niveau scolaire</h5>
                </div>
                <div class="card-body">
                    <div id="levelChart"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'custom_admin/js/plugins/apexcharts.min.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const data = {{ analytics|safe }};

    // Graphique principal
    new ApexCharts(document.querySelector("#activityChart"), {
        series: [
            { name: 'Corrections photo', data: data.daily_images },
            { name: 'Questions chat', data: data.daily_chat },
            { name: 'Revenus', data: data.daily_revenue }
        ],
        chart: { type: 'area', height: 350, toolbar: { show: false } },
        colors: ['#0d9488', '#3b82f6', '#f59e0b'],
        stroke: { width: 2, curve: 'smooth' },
        xaxis: { categories: data.day_labels },
        yaxis: [{ title: { text: 'Actions' } }, { opposite: true, title: { text: 'Revenus (CFA)' } }],
        fill: { opacity: 0.1 },
        legend: { position: 'top' }
    }).render();

    // Donut usage
    new ApexCharts(document.querySelector("#usageChart"), {
        series: data.usage.series,
        chart: { type: 'donut', height: 300 },
        labels: data.usage.labels,
        colors: ['#10b981', '#3b82f6'],
        legend: { position: 'bottom' }
    }).render();

    // Niveau scolaire
    new ApexCharts(document.querySelector("#levelChart"), {
        series: [{ name: 'Utilisateurs', data: data.levels.series }],
        chart: { type: 'bar', height: 300 },
        colors: ['#8b5cf6'],
        xaxis: { categories: data.levels.labels },
        plotOptions: { bar: { horizontal: true } }
    }).render();
});

function refreshAnalytics() {
    const period = document.getElementById('periodSelect').value;
    window.location.href = `?period=${period}`;
}
</script>

<style>
.blink { animation: blink 1.5s infinite; }
@keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
</style>
{% endblock %}