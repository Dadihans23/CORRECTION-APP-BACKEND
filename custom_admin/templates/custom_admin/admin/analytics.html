{% extends 'custom_admin/base_admin.html' %}
{% load static %}

{% block title %}Analytics - Esacode Admin{% endblock %}

{% block extra_css %}
<link type="text/css" href="{% static 'custom_admin/css/plugins/apexcharts.css' %}" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="page-title mb-4">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h2 class="breadcrumb-header fw-bold mb-2">üìä Analytics</h2>
                        <p class="text-muted mb-0">Analysez les performances de votre plateforme</p>
                    </div>
                    <div class="d-flex gap-2">
                        <select class="form-select" id="periodSelect" style="width: 150px;">
                            <option value="7">7 derniers jours</option>
                            <option value="30">30 derniers jours</option>
                            <option value="90">90 derniers jours</option>
                        </select>
                        <button class="btn btn-outline-primary" onclick="refreshAnalytics()">
                            <i class="mdi mdi-refresh"></i> Actualiser
                        </button>
                        <button class="btn btn-outline-success" onclick="exportAnalytics()">
                            <i class="mdi mdi-download"></i> Export
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- KPI Cards DYNAMIQUES -->
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="mt-0 mb-1 fw-bold text-primary">{{ analytics.user_growth.this_month }}</h4>
                            <p class="text-muted mb-0">Nouveaux utilisateurs</p>
                            <small class="{% if analytics.user_growth.growth_rate >= 0 %}text-success{% else %}text-danger{% endif %}">
                                <i class="mdi mdi-arrow-{% if analytics.user_growth.growth_rate >= 0 %}up{% else %}down{% endif %}"></i>
                                {{ analytics.user_growth.growth_rate }}%
                            </small>
                        </div>
                        <div class="bg-primary bg-opacity-10 p-3 rounded">
                            <i class="mdi mdi-account-plus text-primary" style="font-size: 1.5rem;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="mt-0 mb-1 fw-bold text-success">${{ analytics.kpi.total_revenue|floatformat:2 }}</h4>
                            <p class="text-muted mb-0">Revenus totaux</p>
                            <small class="text-success"><i class="mdi mdi-arrow-up"></i> +12.5%</small>
                        </div>
                        <div class="bg-success bg-opacity-10 p-3 rounded">
                            <i class="mdi mdi-currency-usd text-success" style="font-size: 1.5rem;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="mt-0 mb-1 fw-bold text-info">{{ analytics.kpi.retention_rate }}%</h4>
                            <p class="text-muted mb-0">Taux de r√©tention</p>
                            <small class="text-success"><i class="mdi mdi-arrow-up"></i> +2.1%</small>
                        </div>
                        <div class="bg-info bg-opacity-10 p-3 rounded">
                            <i class="mdi mdi-heart text-info" style="font-size: 1.5rem;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="mt-0 mb-1 fw-bold text-warning">{{ analytics.kpi.total_api_calls|floatformat:0 }}</h4>
                            <p class="text-muted mb-0">Appels API</p>
                            <small class="text-danger"><i class="mdi mdi-arrow-down"></i> -3.2%</small>
                        </div>
                        <div class="bg-warning bg-opacity-10 p-3 rounded">
                            <i class="mdi mdi-api text-warning" style="font-size: 1.5rem;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="row mb-4">
        <div class="col-xl-8">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-light border-0">
                    <h5 class="mb-0 d-flex align-items-center">
                        <i class="mdi mdi-chart-line me-2"></i>
                        √âvolution des revenus (7 jours)
                    </h5>
                </div>
                <div class="card-body">
                    <div id="revenueChart" style="height:350px;"></div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-light border-0">
                    <h5 class="mb-0 d-flex align-items-center">
                        <i class="mdi mdi-trophy me-2"></i>
                        Top Packs
                    </h5>
                </div>
                <div class="card-body">
                    {% for pack in analytics.top_packs %}
                    <div class="d-flex justify-content-between align-items-center mb-3 p-2 bg-light rounded">
                        <div>
                            <h6 class="mb-1">{{ pack.name }}</h6>
                            <small class="text-muted">{{ pack.sales }} ventes</small>
                        </div>
                        <div class="text-end">
                            <strong class="text-primary">${{ pack.revenue|floatformat:2 }}</strong>
                        </div>
                    </div>
                    {% empty %}
                    <p class="text-muted text-center">Aucune vente r√©cente</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Usage Analytics -->
    <div class="row mb-4">
        <div class="col-xl-6">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-light border-0">
                    <h5 class="mb-0 d-flex align-items-center">
                        <i class="mdi mdi-chart-donut me-2"></i>
                        Utilisation API par endpoint
                    </h5>
                </div>
                <div class="card-body">
                    <div id="apiUsageChart" style="height: 300px;"></div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-6">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-light border-0">
                    <h5 class="mb-0 d-flex align-items-center">
                        <i class="mdi mdi-earth me-2"></i>
                        Utilisateurs par langue
                    </h5>
                </div>
                <div class="card-body">
                    <div id="geoChart" style="height: 300px;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Real-time Stats -->
    {% comment %} <div class="row">
        <div class="col-xl-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-light border-0">
                    <h5 class="mb-0 d-flex align-items-center">
                        <i class="mdi mdi-pulse me-2"></i>
                        Statistiques en temps r√©el
                        <span class="badge bg-success ms-2">
                            <i class="mdi mdi-circle" style="font-size: 8px;"></i> Live
                        </span>
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-3">
                            <h3 class="text-primary live-counter" data-target="{{ analytics.live.active_users }}">0</h3>
                            <p class="text-muted">Utilisateurs actifs</p>
                        </div>
                        <div class="col-md-3">
                            <h3 class="text-success live-counter" data-target="{{ analytics.live.api_calls }}">0</h3>
                            <p class="text-muted">Appels API/h</p>
                        </div>
                        <div class="col-md-3">
                            <h3 class="text-warning live-counter" data-target="{{ analytics.live.characters }}">0</h3>
                            <p class="text-muted">Caract√®res (K)</p>
                        </div>
                        <div class="col-md-3">
                            <h3 class="text-info live-counter" data-target="{{ analytics.live.subscriptions }}">0</h3>
                            <p class="text-muted">Nouvelles souscriptions</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div> {% endcomment %}
</div>

<!-- Toast Container -->
<div class="toast-container position-fixed bottom-0 end-0 p-3"></div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'custom_admin/js/plugins/apexcharts.min.js' %}"></script>
<script>
$(document).ready(function() {
    // Revenue Chart DYNAMIQUE
    const revenueOptions = {
        series: [{
            name: 'Revenus',
            data: {{ analytics.daily_revenue|safe }}
        }],
        chart: { type: 'area', height: 350, toolbar: { show: true } },
        colors: ['#28a745'],
        fill: {
            type: 'gradient',
            gradient: {
                shadeIntensity: 1,
                opacityFrom: 0.7,
                opacityTo: 0.1,
                colorStops: [{ offset: 0, color: '#28a745', opacity: 0.7 }, { offset: 100, color: '#28a745', opacity: 0.1 }]
            }
        },
        stroke: { curve: 'smooth', width: 3 },
        xaxis: { categories: {{ analytics.day_labels|safe }} },
        yaxis: { title: { text: 'Revenus ($)' } },
        tooltip: { y: { formatter: val => '$' + val.toFixed(2) } }
    };
    new ApexCharts(document.querySelector("#revenueChart"), revenueOptions).render();

    // API Usage Donut Chart DYNAMIQUE - CORRIG√â
    const apiOptions = {
        series: {{ analytics.api_usage_series|safe }},
        chart: { type: 'donut', height: 300 },
        labels: {{ analytics.api_usage_labels|safe }},
        colors: ['#28a745', '#007bff', '#ffc107', '#dc3545'],
        legend: { position: 'bottom' },
        dataLabels: { enabled: true }
    };
    new ApexCharts(document.querySelector("#apiUsageChart"), apiOptions).render();

    // Geo Chart DYNAMIQUE
    const geoOptions = {
        series: [{ data: {{ analytics.geo_series|safe }} }],
        chart: { type: 'bar', height: 300, toolbar: { show: false } },
        colors: ['#007bff'],
        xaxis: { categories: {{ analytics.geo_countries|safe }} },
        plotOptions: { bar: { horizontal: true } },
        dataLabels: { enabled: true }
    };
    new ApexCharts(document.querySelector("#geoChart"), geoOptions).render();

    // Live counters
    $('.live-counter').each(function() {
        const target = parseInt($(this).data('target'));
        const element = this;
        let current = 0;
        const increment = target / 100;
        
        const timer = setInterval(() => {
            current += increment;
            if (current >= target) {
                current = target;
                clearInterval(timer);
            }
            $(element).text(Math.floor(current));
        }, 20);
    });

    // Auto-refresh every 30s
    setInterval(() => location.reload(), 30000);
});

function refreshAnalytics() {
    const period = $('#periodSelect').val();
    window.location.href = `/admin/analytics/?period=${period}`;
}

function exportAnalytics() {
    showToast('Analytics export√©s avec succ√®s!', 'success');
}

function showToast(message, type = 'info') {
    const toast = $(`
        <div class="toast align-items-center text-white bg-${type == 'success' ? 'success' : 'primary'} border-0" role="alert">
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    `);
    toast.toast({ delay: 3000 });
    $('.toast-container').append(toast);
    toast.toast('show');
}
</script>
{% endblock %}