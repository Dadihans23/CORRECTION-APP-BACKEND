{% extends 'custom_admin/base_admin.html' %}
{% load static %}

{% block title %}Modifier #{{ user.id }} - Corrige Moi Admin{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="page-title mb-4">
                <div class="d-flex justify-content-between align-items-center flex-wrap">
                    <div>
                        <h3 class="fw-bold mb-1">Modifier l'utilisateur</h3>
                        <p class="text-muted mb-0">Éditez les informations de {{ user.get_full_name }}</p>
                    </div>
                    <div>
                        <ol class="breadcrumb m-0">
                            <li class="breadcrumb-item"><a href="{% url 'custom_admin:dashboard' %}">Admin</a></li>
                            <li class="breadcrumb-item"><a href="{% url 'custom_admin:users' %}">Utilisateurs</a></li>
                            <li class="breadcrumb-item active">Modifier</li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Formulaire -->
        <div class="col-xl-8">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <h5 class="mb-3 border-bottom pb-2">Informations personnelles</h5>

                    <form method="post">
                        {% csrf_token %}
                        <div class="row g-3">
                            <!-- Prénom & Nom -->
                            <div class="col-md-6">
                                <label class="form-label">Prénom <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" name="first_name" value="{{ user.first_name }}" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Nom <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" name="last_name" value="{{ user.last_name }}" required>
                            </div>

                            <!-- Téléphone (lecture seule) -->
                            <div class="col-md-6">
                                <label class="form-label">Téléphone</label>
                                <input type="text" class="form-control" value="{{ user.phone_number }}" disabled>
                                <small class="text-muted">Non modifiable</small>
                            </div>

                            <!-- Email -->
                            <div class="col-md-6">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-control" name="email" value="{{ user.email|default:'' }}">
                            </div>

                            <!-- Pays & Niveau -->
                            <div class="col-md-6">
                                <label class="form-label">Pays</label>
                                <input type="text" class="form-control" name="country" value="{{ user.country|default:'' }}">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Niveau scolaire</label>
                                <select class="form-select" name="school_level">
                                    <option value="">— Choisir —</option>
                                    <option value="Primaire" {% if user.school_level == "Primaire" %}selected{% endif %}>Primaire</option>
                                    <option value="Collège" {% if user.school_level == "Collège" %}selected{% endif %}>Collège</option>
                                    <option value="Lycée" {% if user.school_level == "Lycée" %}selected{% endif %}>Lycée</option>
                                    <option value="Université" {% if user.school_level == "Université" %}selected{% endif %}>Université</option>
                                </select>
                            </div>

                            <!-- Établissement & Âge -->
                            <div class="col-md-8">
                                <label class="form-label">Établissement</label>
                                <input type="text" class="form-control" name="institution" value="{{ user.institution|default:'' }}">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Âge</label>
                                <input type="number" class="form-control" name="age" value="{{ user.age|default:'' }}" min="5" max="100">
                            </div>
                        </div>

                        <h5 class="mt-4 mb-3 border-bottom pb-2">Permissions</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="isActive" name="is_active" {% if user.is_active %}checked{% endif %}>
                                    <label class="form-check-label" for="isActive">Compte actif</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="isStaff" name="is_staff" {% if user.is_staff %}checked{% endif %}>
                                    <label class="form-check-label" for="isStaff">Accès administrateur</label>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex gap-2 mt-4">
                            <button type="submit" class="btn btn-primary">
                                <i class="mdi mdi-content-save"></i> Sauvegarder
                            </button>
                            <a href="{% url 'custom_admin:user_detail' user.id %}" class="btn btn-outline-info">
                                <i class="mdi mdi-eye"></i> Voir détails
                            </a>
                            <a href="{% url 'custom_admin:users' %}" class="btn btn-outline-secondary">
                                <i class="mdi mdi-arrow-left"></i> Retour
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Aperçu en temps réel -->
        <div class="col-xl-4">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center">
                    <h6 class="mb-3">Aperçu utilisateur</h6>
                    <div class="avatar-lg bg-primary rounded-circle mx-auto mb-3 d-flex align-items-center justify-content-center">
                        <i class="mdi mdi-account text-white" style="font-size: 3rem;"></i>
                    </div>
                    <h5 id="previewName">{{ user.get_full_name|default:"Nom complet" }}</h5>
                    <p class="text-muted small" id="previewPhone">+{{ user.phone_number }}</p>
                    <p class="text-muted small" id="previewEmail">{{ user.email|default:"" }}</p>

                    <div class="mt-3 d-flex justify-content-center gap-2 flex-wrap">
                        <span class="badge bg-success" id="statusBadge" {% if not user.is_active %}style="display:none"{% endif %}>
                            <i class="mdi mdi-check-circle"></i> Actif
                        </span>
                        <span class="badge bg-danger" id="inactiveBadge" {% if user.is_active %}style="display:none"{% endif %}>
                            <i class="mdi mdi-close-circle"></i> Inactif
                        </span>
                        <span class="badge bg-warning text-dark" id="staffBadge" {% if not user.is_staff %}style="display:none"{% endif %}>
                            <i class="mdi mdi-shield-account"></i> Staff
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const $ = (s) => document.querySelector(s);

    // Mise à jour en temps réel
    $('[name="first_name"], [name="last_name"]').forEach(el => {
        el.addEventListener('input', () => {
            const first = $('[name="first_name"]').value.trim();
            const last = $('[name="last_name"]').value.trim();
            $('#previewName').textContent = first || last ? `${first} ${last}`.trim() : 'Nom complet';
        });
    });

    $('[name="email"]').addEventListener('input', () => {
        const email = $('[name="email"]').value || 'email@example.com';
        $('#previewEmail').textContent = email;
    });

    $('#isActive').addEventListener('change', function () {
        $('#statusBadge').style.display = this.checked ? 'inline-flex' : 'none';
        $('#inactiveBadge').style.display = this.checked ? 'none' : 'inline-flex';
    });

    $('#isStaff').addEventListener('change', function () {
        $('#staffBadge').style.display = this.checked ? 'inline-flex' : 'none';
    });
});
</script>

<style>
.avatar-lg { width: 80px; height: 80px; }
.form-check-input:checked { background-color: #0d9488; border-color: #0d9488; }
</style>
{% endblock %}