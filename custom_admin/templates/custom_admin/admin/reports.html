{% extends 'custom_admin/base_admin.html' %}
{% load static %}

{% block title %}Rapports - Esacode Admin{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="page-title mb-4">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h2 class="breadcrumb-header fw-bold mb-2">üìã Rapports</h2>
                        <p class="text-muted mb-0">G√©n√©rez et consultez vos rapports personnalis√©s</p>
                    </div>
                    <div class="d-flex gap-2">
                        {% comment %} <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createReportModal">
                            <i class="mdi mdi-plus"></i> Nouveau rapport
                        </button> {% endcomment %}
                        <button class="btn btn-outline-success" onclick="exportAllReports()">
                            <i class="mdi mdi-download"></i> Exporter tout ({{ reports.total_reports }})
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Reports Cards DYNAMIQUES -->
<div class="container-fluid">
    <div class="row mb-4">
        {% for report in reports.available_reports %}
        <div class="col-xl-4 col-md-6 mb-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="avatar-lg {% if report.type == 'sales' %}bg-primary{% elif report.type == 'api_usage' %}bg-success{% else %}bg-warning{% endif %} rounded-circle mx-auto mb-3 d-flex align-items-center justify-content-center">
                        <i class="mdi mdi-{% if report.type == 'sales' %}chart-line{% elif report.type == 'api_usage' %}api{% else %}account-group{% endif %} text-white" style="font-size: 2rem;"></i>
                    </div>
                    <h5 class="card-title">{{ report.name }} hii</h5>
                    <p class="text-muted">
                        {% if report.type == 'sales' %}{{ report.total_sales }} ventes ‚Ä¢ ${{ report.total_revenue|floatformat:2 }}
                        {% elif report.type == 'api_usage' %}{{ report.total_calls }} appels ‚Ä¢ {{ report.top_endpoint.count }} {{ report.top_endpoint.request_type }}
                        {% else %}{{ report.active_users }} actifs ‚Ä¢ {{ report.new_users }} nouveaux
                        {% endif %}
                    </p>
                    <small class="text-muted">Dernier: {{ report.last_generated|date:"d/m H:i" }}</small>
                    <div class="mt-3">
                        <button class="btn btn-outline-{% if report.type == 'sales' %}primary{% elif report.type == 'api_usage' %}success{% else %}warning{% endif %} btn-sm" onclick="generateReport('{{ report.type }}')">
                            <i class="mdi mdi-file-chart"></i> G√©n√©rer
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Reports History DYNAMIQUE -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-light border-0">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="mdi mdi-history me-2"></i>
                            Historique des rapports ({{ reports.total_reports }})
                        </h5>
                        <div class="d-flex gap-2">
                            <input type="text" class="form-control search-input" id="reportSearch" placeholder="Rechercher..." style="width: 250px;">
                            <select class="form-select" id="reportFilter" style="width: 150px;">
                                <option value="all">Tous les types</option>
                                <option value="sales">Ventes</option>
                                <option value="api_usage">Usage API</option>
                                <option value="users">Utilisateurs</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>#</th>
                                    <th>Nom du rapport</th>
                                    <th>Type</th>
                                    <th>P√©riode</th>
                                    <th>G√©n√©r√© le</th>
                                    <th>Statut</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="reportTableBody">
                                {% for report in reports.report_history %}
                                <tr data-type="{{ report.type }}">
                                    <th scope="row">{{ report.id }}</th>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="me-2">
                                                <i class="mdi mdi-{% if report.type == 'sales' %}chart-line{% elif report.type == 'api_usage' %}api{% else %}account-group{% endif %} text-primary"></i>
                                            </div>
                                            <strong>{{ report.name }}</strong>
                                            {% if report.type == 'sales' %}
                                                <span class="badge bg-success ms-2">${{ report.amount|floatformat:2 }}</span>
                                            {% elif report.type == 'api_usage' %}
                                                <span class="badge bg-info ms-2">{{ report.calls }} appels</span>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge bg-{% if report.type == 'sales' %}primary{% elif report.type == 'api_usage' %}success{% else %}warning{% endif %}">
                                            {{ report.type|title }}
                                        </span>
                                    </td>
                                    <td>{{ report.period }}</td>
                                    <td>
                                        <small class="text-muted">{{ report.generated_at|date:"d/m/Y" }}</small>
                                    </td>
                                    <td>
                                        <span class="badge bg-success">
                                            <i class="mdi mdi-check-circle"></i> Pr√™t
                                        </span>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm" role="group">
                                            <button class="btn btn-outline-primary" onclick="previewReport({{ report.id }})" title="Aper√ßu">
                                                <i class="mdi mdi-eye"></i>
                                            </button>
                                            <button class="btn btn-outline-success" onclick="downloadReport('{{ report.type }}', {{ report.id }})" title="T√©l√©charger">
                                                <i class="mdi mdi-download"></i>
                                            </button>
                                            
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="7" class="text-center py-4">
                                        <i class="mdi mdi-file-document-outline text-muted" style="font-size: 3rem;"></i>
                                        <p class="text-muted mt-2">Aucun rapport g√©n√©r√©</p>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scheduled Reports DYNAMIQUES -->
    {% comment %} <div class="row">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-light border-0">
                    <h5 class="mb-0 d-flex align-items-center">
                        <i class="mdi mdi-calendar-clock me-2"></i>
                        Rapports programm√©s
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for schedule in reports.scheduled_reports %}
                        <div class="col-md-4 mb-3">
                            <div class="card bg-light h-100">
                                <div class="card-body">
                                    <h6 class="card-title d-flex align-items-center">
                                        <i class="mdi mdi-{% if schedule.frequency == 'weekly' %}calendar-week{% else %}calendar-month{% endif %} text-primary me-2"></i>
                                        {{ schedule.name }}
                                    </h6>
                                    <p class="card-text small text-muted">
                                        Tous les {{ schedule.frequency }}<br>
                                        Prochaine ex√©cution: {{ schedule.next_run|date:"d/m/Y H:i" }}
                                    </p>
                                    <div class="d-flex gap-1">
                                        <button class="btn btn-sm btn-outline-primary">
                                            <i class="mdi mdi-pencil"></i> Modifier
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger">
                                            <i class="mdi mdi-delete"></i> Supprimer
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                        <div class="col-md-4">
                            <div class="card border-2 border-dashed h-100">
                                <div class="card-body text-center">
                                    <i class="mdi mdi-plus-circle text-muted" style="font-size: 2rem;"></i>
                                    <p class="text-muted mt-2">Ajouter une programmation</p>
                                    <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#scheduleModal">
                                        Programmer
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div> {% endcomment %}
</div>

<!-- Create Report Modal -->
<div class="modal fade" id="createReportModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Cr√©er un nouveau rapport</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="reportForm">
                    <div class="mb-3">
                        <label class="form-label">Nom du rapport</label>
                        <input type="text" class="form-control" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Type de rapport</label>
                        <select class="form-select" name="type" required>
                            <option value="sales">Ventes</option>
                            <option value="api_usage">Usage API</option>
                            <option value="users">Utilisateurs</option>
                            <option value="financial">Financier</option>
                        </select>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Date de d√©but</label>
                                <input type="date" class="form-control" name="start_date" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Date de fin</label>
                                <input type="date" class="form-control" name="end_date" required>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Formats</label>
                        <div class="d-flex gap-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="pdf" name="formats" checked>
                                <label class="form-check-label">PDF</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="excel" name="formats">
                                <label class="form-check-label">Excel</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="csv" name="formats">
                                <label class="form-check-label">CSV</label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary" onclick="createReport()">Cr√©er le rapport</button>
            </div>
        </div>
    </div>
</div>

<!-- Preview Modal -->
<div class="modal fade" id="detailsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Aper√ßu du rapport</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Contenu dynamique -->
            </div>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div class="toast-container position-fixed bottom-0 end-0 p-3"></div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Recherche et filtre
    $('#reportSearch').on('keyup', function() {
        filterReports();
    });
    $('#reportFilter').on('change', function() {
        filterReports();
    });
});

function filterReports() {
    const search = $('#reportSearch').val().toLowerCase();
    const type = $('#reportFilter').val();
    
    $('#reportTableBody tr').each(function() {
        const row = $(this);
        const text = row.text().toLowerCase();
        const rowType = row.data('type');
        
        const show = (text.includes(search) && (type === 'all' || rowType === type));
        row.toggle(show);
    });
}function generateReport(type) {
    showToast(`G√©n√©ration du rapport ${type} en cours...`, 'info');
    
    // REDIRECTION VRAIE VERS VUE DJANGO
    window.open(`/admin/reports/${type}/generate/`, '_blank');
    
    setTimeout(() => {
        showToast(`Rapport ${type} g√©n√©r√© et t√©l√©charg√© !`, 'success');
    }, 1500);
}

function downloadReport(type, id) {
    showToast(`T√©l√©chargement du rapport #${id} (${type})...`, 'info');
    
    // REDIRECTION VRAIE
    window.location.href = `/admin/reports/${type}/${id}/download/`;
}

function previewReport(id) {
    $('#modalTitle').text(`Aper√ßu du rapport #${id}`);
    $('#modalBody').html(`
        <div class="text-center py-4">
            <i class="mdi mdi-file-chart text-primary" style="font-size: 3rem;"></i>
            <h5 class="mt-3">Rapport #${id}</h5>
            <p class="text-muted">Fichier pr√™t √† t√©l√©charger</p>
            <div class="mt-4">
                <a href="/admin/reports/sales/${id}/download/" class="btn btn-primary me-2">
                    <i class="mdi mdi-download"></i> T√©l√©charger PDF
                </a>
                {% comment %} <button class="btn btn-outline-secondary" onclick="printReport(${id})">
                    <i class="mdi mdi-printer"></i> Imprimer
                </button> {% endcomment %}
            </div>
        </div>
    `);
    $('#detailsModal').modal('show');
}

function createReport() {
    // ENVOYER FORMULAIRE VRAI
    $.post('/admin/reports/create/', $('#reportForm').serialize(), function() {
        $('#createReportModal').modal('hide');
        showToast('Nouveau rapport cr√©√© et t√©l√©charg√© !', 'success');
        window.location.reload();
    });
}

function exportAllReports() {
    showToast(`Export de ${reports.total_reports} rapports en cours...`, 'info');
    window.location.href = '/admin/reports/export-all/';
}

function showToast(message, type = 'info') {
    const toast = $(`
        <div class="toast align-items-center text-white bg-${type == 'success' ? 'success' : 'primary'} border-0" role="alert">
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    `);
    toast.toast({ delay: 3000 });
    $('.toast-container').append(toast);
    toast.toast('show');
}
</script>
{% endblock %}