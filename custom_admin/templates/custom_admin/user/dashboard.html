{% extends 'custom_admin/base_user.html' %}
{% load static %}

{% block title %}Mon Dashboard - Esacode{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Welcome Header -->
    <div class="row">
        <div class="col-12">
            <div class="page-title mb-4">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h3 class="breadcrumb-header">Bonjour, {{ user.first_name|default:user.username }} üëã</h3>
                        <p class="text-muted mb-0">G√©rez votre compte et suivez votre utilisation</p>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-primary" onclick="showUserProfile()">
                            <i class="mdi mdi-account-edit"></i> Mon Profil
                        </button>
                        <a href="{% url 'front:documentation' %}" class="btn btn-primary">
                            <i class="mdi mdi-api"></i> Documentation API
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- User Stats Cards -->
    <div class="row">
        <div class="col-xl-3 col-md-6">
            <div class="card border-0 esacode-stat-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="text-primary mb-0">{{ user_data.tokens_remaining|default:"8,750" }}</h4>
                            <p class="text-muted mb-0">Tokens restants</p>
                        </div>
                        <div class="widget-icon bg-primary-light rounded">
                            <i class="mdi mdi-coin text-primary" style="font-size: 2rem;"></i>
                        </div>
                    </div>
                    <div class="progress mt-3" style="height: 6px;">
                        <div class="progress-bar bg-primary" style="width: {{ user_data.tokens_percentage|default:87 }}%"></div>
                    </div>
                    <small class="text-muted">{{ user_data.tokens_used|default:"1,250" }} tokens utilis√©s</small>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6">
            <div class="card border-0 esacode-stat-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="text-success mb-0">{{ user_data.api_calls_count}}</h4>
                            <p class="text-muted mb-0">Appels API ce mois</p>
                        </div>
                        <div class="widget-icon bg-success-light rounded">
                            <i class="mdi mdi-api text-success" style="font-size: 2rem;"></i>
                        </div>
                    </div>
                    <small class="text-muted">Dernier appel {{ user_data.last_api_call|default:"Il y a 2h" }}</small>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6">
            <div class="card border-0 esacode-stat-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="text-warning mb-0">{{ user_data.subscription_days_left }}</h4>
                            <p class="text-muted mb-0">Jours restants</p>
                        </div>
                        <div class="widget-icon bg-warning-light rounded">
                            <i class="mdi mdi-calendar-clock text-warning" style="font-size: 2rem;"></i>
                        </div>
                    </div>
                    <small class="text-muted">Expire le {{ user_data.expiration_date|default:"25 Sept 2024" }}</small>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6">
            <div class="card border-0 esacode-stat-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="text-info mb-0">${{ user_data.total_spent|default:"89.97" }}</h4>
                            <p class="text-muted mb-0">Total d√©pens√©</p>
                        </div>
                        <div class="widget-icon bg-info-light rounded">
                            <i class="mdi mdi-cash text-info" style="font-size: 2rem;"></i>
                        </div>
                    </div>
                    <small class="text-muted">Prochaine facturation {{ user_data.next_billing|default:"25 Sept 2024" }}</small>
                </div>
            </div>
        </div>
    </div>

  <!-- Main Content Row -->
        <div class="row">
            <!-- Recent Requests - Full Width -->
            <div class="col-12">
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-light border-0">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0 d-flex align-items-center">
                                <i class="mdi mdi-history me-2"></i>
                                Mes requ√™tes r√©centes
                            </h5>
                            <a href="{% url 'custom_admin:user_requests' %}" class="btn btn-outline-primary btn-sm">
                                <i class="mdi mdi-eye me-1"></i> Voir tout
                            </a>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Type</th>
                                        <th>Statut</th>
                                        <th>Tokens</th>
                                        <th>Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for request in recent_requests %}
                                    <tr>
                                        <td>
                                            <span class="badge {% if request.type == 'Text-to-Speech' %}bg-primary{% elif request.type == 'Traduction' %}bg-info{% else %}bg-secondary{% endif %}">
                                                {% if request.type == 'Text-to-Speech' %}üé§ TTS
                                                {% elif request.type == 'Traduction' %}üåê Traduction
                                                {% else %}üîç D√©tection{% endif %}
                                            </span>
                                        </td>
                                        <td>
                                            <span class="badge {% if request.status == 'succ√®s' %}bg-success{% else %}bg-danger{% endif %}">
                                                {% if request.status == 'succ√®s' %}‚úÖ Succ√®s{% else %}‚ùå Erreur{% endif %}
                                            </span>
                                        </td>
                                        <td>{{ request.tokens }} tokens</td>
                                        <td>{{ request.date }}</td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-info" onclick="EsacodeUser.viewRequest({{ request.id }})">
                                                <i class="mdi mdi-eye"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="5" class="text-center">Aucune requ√™te r√©cente.</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    <!-- Second Row: Pack and API Key side by side -->
    <div class="row">
        <!-- Current Pack -->
        <div class="col-md-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-light border-0">
                    <h5 class="mb-0 d-flex align-items-center">
                        <i class="mdi mdi-package-variant me-2"></i>
                        Mon pack actuel
                    </h5>
                </div>
                <div class="card-body">
                    <div class="text-center mb-3">
                        <div class="pack-icon bg-primary bg-opacity-10 p-3 rounded-circle d-inline-flex align-items-center justify-content-center">
                            <i class="mdi mdi-crown text-primary" style="font-size: 2rem;"></i>
                        </div>
                    </div>
                    <div class="text-center">
                        <h4 class="mb-1">{{ user_data.current_pack.name|default:"Pack Pro" }}</h4>
                        <p class="text-muted mb-3">${{ user_data.current_pack.price|default:"29.99" }}/mois</p>
                        <p class="mb-3">{{ user_data.current_pack.token_limit|default:"10,000" }} tokens inclus</p>
                        <div class="d-flex gap-2 justify-content-center">
                            <a href="{% url 'custom_admin:user_settings' %}" class="btn btn-outline-primary btn-sm">
                                <i class="mdi mdi-cog me-1"></i> G√©rer
                            </a>
                            <a href="#" class="btn btn-primary btn-sm" onclick="upgradePackModal()">
                                <i class="mdi mdi-arrow-up me-1"></i> Upgrade
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- API Key -->
        <div class="col-md-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-light border-0">
                    <h5 class="mb-0 d-flex align-items-center">
                        <i class="mdi mdi-key me-2"></i>
                        Ma cl√© API
                    </h5>
                </div>
                <div class="card-body">
                    <div class="text-center mb-3">
                        <div class="api-icon bg-success bg-opacity-10 p-3 rounded-circle d-inline-flex align-items-center justify-content-center">
                            <i class="mdi mdi-api text-success" style="font-size: 2rem;"></i>
                        </div>
                    </div>
                    <div class="api-key-section">
                        <label class="form-label small text-muted">Votre cl√© API:</label>
                        <div class="input-group mb-3">
                            <input type="text" class="form-control font-monospace" id="apiKey" 
                                   value="{{ user_data.api_key|default:'sk-usr-abc123def456ghi789jkl012' }}" readonly>
                            <button class="btn btn-outline-secondary" onclick="copyApiKey()" title="Copier">
                                <i class="mdi mdi-content-copy"></i>
                            </button>
                        </div>
                        <div class="d-flex gap-2 justify-content-center">
                            <button class="btn btn-outline-warning btn-sm" onclick="regenerateApiKey()">
                                <i class="mdi mdi-refresh me-1"></i> R√©g√©n√©rer
                            </button>
                            <a href="#" class="btn btn-info btn-sm">
                                <i class="mdi mdi-book-open me-1"></i> Documentation
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function showUserProfile() {
    window.location.href = "{% url 'custom_admin:user_settings' %}";
}

function upgradePackModal() {
    $('#detailsModal .modal-title span').text('Upgrade de Pack');
    $('#detailsModal .modal-body').html(`
        <div class="text-center py-4">
            <i class="mdi mdi-rocket text-primary" style="font-size: 3rem;"></i>
            <h5 class="mt-3">Mettre √† niveau votre Pack</h5>
            <p class="text-muted">Acc√©dez √† plus de tokens et fonctionnalit√©s premium.</p>
            <a href="{% url 'custom_admin:user_settings' %}" class="btn btn-primary">
                Voir les options
            </a>
        </div>
    `);
    $('#detailsModal').modal('show');
}

function copyApiKey() {
    const apiKeyInput = document.getElementById('apiKey');
    apiKeyInput.select();
    document.execCommand('copy');
    
    // Show success message
    $('#successModal #successMessage').text('Cl√© API copi√©e dans le presse-papiers!');
    $('#successModal').modal('show');
}

function regenerateApiKey() {
    if (confirm('√ätes-vous s√ªr de vouloir r√©g√©n√©rer votre cl√© API? L\'ancienne cl√© ne fonctionnera plus.')) {
        // Simulate API key regeneration
        const newKey = 'sk-usr-' + Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
        document.getElementById('apiKey').value = newKey;
        
        $('#successModal #successMessage').text('Nouvelle cl√© API g√©n√©r√©e avec succ√®s!');
        $('#successModal').modal('show');
    }
}

// Extend EsacodeUser with additional methods
window.EsacodeUser.viewRequest = function(requestId) {
    $('#detailsModal .modal-title span').text(`Request #${requestId}`);
    $('#detailsModal .modal-body').html(`
        <div class="text-center py-4">
            <i class="mdi mdi-file-document text-info" style="font-size: 3rem;"></i>
            <h5 class="mt-3">D√©tails de la Request</h5>
            <p class="text-muted">Informations compl√®tes sur votre requ√™te #${requestId}.</p>
        </div>
    `);
    $('#detailsModal').modal('show');
};
</script>
{% endblock %}